package com.qigan.qiganshop.controller.backstage;

import com.qigan.qiganshop.constant.RedisConstant;
import com.qigan.qiganshop.controller.utils.PublicControl;
import com.qigan.qiganshop.enums.CouponType;
import com.qigan.qiganshop.myutils.SqlConstructUtils;
import com.qigan.qiganshop.pojo.CommonPage;
import com.qigan.qiganshop.pojo.Coupon;
import com.qigan.qiganshop.pojo.CouponDetailsModel;
import com.qigan.qiganshop.service.CouponService;
import com.qigan.qiganshop.util.access.JedisUtil;
import com.qigan.qiganshop.util.notnull.StringNotNull;
import com.qigan.qiganshop.util.result.PageResult;
import com.qigan.qiganshop.util.result.XltcResult;
import com.qigan.qiganshop.util.result.format.JsonResult;
import com.qigan.qiganshop.util.result.format.ResultCode;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RestController;

import java.util.List;
import java.util.Map;
import java.util.Set;

/**
 * ‰ºòÊÉ†Âà∏ controller
 *
 * @author wanghao
 * @time 2019-05-05 17:51
 */
@SuppressWarnings("all")

@RestController
@RequestMapping("/Coupon")
@Api(value = "‰ºòÊÉ†Âà∏ controller", tags = {"WEB ‰ºòÊÉ†Âà∏Êìç‰ΩúÊé•Âè£"})
public class CouponController {
    @Autowired
    private CouponService service;
    @Autowired
    private JsonResult jr;
    @Autowired
    private PublicControl pc;
    @Autowired
    private JedisUtil jedisUtil;


    /**
     * Ê∑ªÂä†Á∫øÁ¥¢Áî®Êà∑Á¶èÂà©‰ºòÊÉ†Âç∑
     * @param couponIds
     * @return
     */
    @RequestMapping(value = "/addClueUserCoupons.do",method = RequestMethod.POST)
    public XltcResult addClueUserCoupons(@RequestBody List<Map<String,String>> data){
        if(SqlConstructUtils.nullList(data))
            return XltcResult.error("ËØ∑‰º†ÂÖ•Ëá≥Â∞ë‰∏Ä‰∏™‰ºòÊÉ†Âç∑idÔºÅ");
        for (Map<String, String> couponDateMap : data) {
            String couponId = couponDateMap.get("couponId");
            String useAbleDay = couponDateMap.get("end");
            if(StringNotNull.check(couponId,useAbleDay)){
                jedisUtil.setToHash(RedisConstant.CLUE_USER_COUPONS,couponId,useAbleDay);
            }
        }
        return XltcResult.ok();
    }


    /**
     * Ëé∑ÂèñÂΩìÂâçÁ∫øÁ¥¢Áî®Êà∑Á¶èÂà©‰ºòÊÉ†Âç∑
     * @return
     */
    @RequestMapping(value = "/findClueUserCoupons.do",method = RequestMethod.GET)
    public XltcResult findClueUserCoupons(){
        Set<String> elements = jedisUtil.getElementsFromHash(RedisConstant.CLUE_USER_COUPONS);
        String couponIds = SqlConstructUtils.constructListToStringsOnIn(null, elements);
        if(couponIds==null)
            return XltcResult.ok();
        List<Coupon> list = service.findCouponByIds(couponIds);
        return XltcResult.ok(list);
    }

    /**
     * ÁßªÈô§ÂΩìÂâçÁ∫øÁ¥¢Áî®Êà∑Á¶èÂà©‰ºòÊÉ†Âç∑
     * @param couponIds
     * @return
     */
    @RequestMapping(value = "/removeClueUserCoupons.do",method = RequestMethod.POST)
    public XltcResult removeClueUserCoupons(@RequestBody List<String> couponIds){
        if(SqlConstructUtils.nullList(couponIds))
            return XltcResult.ok();
        for (String couponId : couponIds) {
            jedisUtil.removeElementFromHash(RedisConstant.CLUE_USER_COUPONS,couponId);
        }
        return XltcResult.ok();
    }


    /**
     * ‰ºòÊÉ†Âà∏Êü•ËØ¢‰∏âÂêà‰∏Ä
     *
     * @param coupon
     * @param page
     * @param size
     * @return
     */
    @RequestMapping("findPage.do")
    @ApiOperation(
            value = "ÂàÜÈ°µËé∑ÂèñÊâÄÊúâÁöÑ‰ºòÊÉ†Âà∏ÂàóË°®  ‰ºòÊÉ†Âà∏Á±ªÂûã 1,Êª°Âáè 2,ÂÖçËøêË¥π,3 È∏°ËõãÂà∏",
            notes = "ÂàÜÈ°µËé∑Âèñ‰ºòÊÉ†Âà∏ÂàóË°®‰ø°ÊÅØ,coupon ‰∏∫‰ºòÊÉ†Âà∏ÂÆû‰Ωì,Áî®‰∫éÂä®ÊÄÅÊãºÊé•Êü•ËØ¢Êù°‰ª∂,page ‰∏∫È°µÁ†Å,rows ‰∏∫ÊØèÈ°µËÆ∞ÂΩïÊï∞ \r\n" +
                    "Ëã•Ë¶ÅÊü•ËØ¢ÊâÄÊúâ,‰∏ç‰º†ÈÄí ÂÆû‰Ωì coupon Âç≥ÂèØ,page ‰º†1,rows ‰º† 10(ÈªòËÆ§) \r\n",
            httpMethod = "POST")
    public JsonResult findPage(@RequestBody Coupon coupon, Integer page, Integer size) {
        PageResult result = service.findPage(coupon, page, size);

        return jr.jsonResultData(ResultCode.SUCCESS.res_code(), ResultCode.SUCCESS.message(), result);

    }

    /**
     * Êñ∞Â¢û‰ºòÊÉ†Âà∏
     *
     * @param coupon
     * @return
     */
    @RequestMapping("add.do")
    @ApiOperation(
            value = "Êñ∞Â¢û‰ºòÊÉ†Âà∏",
            notes = "couponId ÂèØ‰ª•‰∏ç‰º†,‰ΩÜÊòØ type,begin,end,ÂøÖ‰º† \r\n" +
                    "Êñ∞Â¢ûÊª°Âáè‰ºòÊÉ†Âà∏,couponName,type,fullMoney,reduceMoney,begin,end ÂøÖ‰º† \r\n" +
                    "Êñ∞Â¢ûÂÖçËøêË¥π‰ºòÊÉ†Âà∏,couponName,type,begin,end ÂøÖ‰º† \r\n" +
                    "Êñ∞Â¢ûÈ∏°Ëõãü•öü•öü•öü•öü•öü•ö‰ºòÊÉ†Âà∏,couponName,type,begin,end,eggNumber ÂøÖ‰º† \n",
            httpMethod = "POST")
    public JsonResult add(@RequestBody Coupon coupon) {
        if (StringNotNull.check(coupon.getType())) {

            return pc.addUtils(service.add(coupon));
        }
        return jr.jsonResultData(ResultCode.FAIL.res_code(), "Ê∑ªÂä†Â§±Ë¥•! type ‰∏∫Á©∫");

    }

    /**
     * ‰øÆÊîπ‰ºòÊÉ†Âà∏
     *
     * @param coupon
     * @return
     */
    @RequestMapping("update.do")
    @ApiOperation(
            value = "‰øÆÊîπ‰ºòÊÉ†Âà∏",
            notes = "couponId ÂèØ‰ª•‰∏ç‰º†,‰ΩÜÊòØ type,begin,end,ÂøÖ‰º† \r\n" +
                    "‰øÆÊîπÊª°Âáè‰ºòÊÉ†Âà∏,couponId,couponName,type,fullMoney,reduceMoney,begin,end ÂøÖ‰º† \r\n" +
                    "‰øÆÊîπÂÖçËøêË¥π‰ºòÊÉ†Âà∏,couponId,couponName,type,begin,end ÂøÖ‰º† \r\n" +
                    "‰øÆÊîπÈ∏°Ëõãü•öü•öü•öü•öü•öü•ö‰ºòÊÉ†Âà∏,couponId,couponName,type,begin,end,eggNumber ÂøÖ‰º† \n",
            httpMethod = "POST")
    public JsonResult update(@RequestBody Coupon coupon) {
        if (StringNotNull.check(coupon.getCouponId()) && StringNotNull.check(coupon.getType())) {
            return pc.updateUtils(service.update(coupon));
        }
        return jr.jsonResultData(ResultCode.FAIL.res_code(), "Êõ¥Êñ∞Â§±Ë¥•! typeÊàñ Id ‰∏∫Á©∫");


    }

    /**
     * ‰øÆÊîπ‰ºòÊÉ†Âà∏
     *
     * @param coupon
     * @return
     */
    @RequestMapping("updateEnable.do")
    @ApiOperation(
            value = "‰øÆÊîπ‰ºòÊÉ†Âà∏",
            notes = "couponIds ÂøÖÈ°ª‰º† flag ÂøÖÈ°ª‰º† ÂêØÁî® 1; Á¶ÅÁî® 0",
            httpMethod = "POST")
    public JsonResult updateEnable(String[] couponIds, String flag) {
        if (StringNotNull.check(flag) && couponIds.length > 0) {
            return pc.updateUtils(service.updateEnable(couponIds, flag));
        }
        return jr.jsonResultData(ResultCode.FAIL.res_code(), "Êõ¥Êñ∞Â§±Ë¥•! couponIds Êàñ flag ‰∏∫Á©∫");




    }

    /**
     * Âà†Èô§‰ºòÊÉ†Âà∏
     *
     * @param ids
     * @return
     */
    @RequestMapping("delete.do")
    @ApiOperation(
            value = "Âà†Èô§‰ºòÊÉ†Âà∏ ",
            notes = "‰ºòÊÉ†Âà∏ Id ÂøÖ‰º†",
            httpMethod = "POST")
    public JsonResult delete(String[] ids) {
        if (ids.length > 0) {
            return pc.deleteUtils(ids, service.delete(ids));
        }
        return jr.jsonResultData(ResultCode.FAIL.res_code(), "Âà†Èô§Â§±Ë¥•!! Id ‰∏∫Á©∫");


    }

    /**
     * Êü•ËØ¢Âçï‰∏™‰ºòÊÉ†Âà∏ËØ¶ÊÉÖ
     *
     * @param couponId
     * @return
     */
    @RequestMapping("findOne.do")
    @ApiOperation(
            value = "Êü•ËØ¢Âçï‰∏™‰ºòÊÉ†Âà∏",
            notes = "‰ºòÊÉ†Âà∏ Id ÂøÖ‰º†",
            httpMethod = "POST")
    public JsonResult findOne(String couponId) {
        if (StringNotNull.check(couponId)) {
            return jr.jsonResultData(ResultCode.SUCCESS.res_code(), ResultCode.SUCCESS.message(), service.findOne(couponId));
        }
        return jr.jsonResultData(ResultCode.FAIL.res_code(), "Âà†Èô§Â§±Ë¥•!! Id ‰∏∫Á©∫", new Coupon());
    }
    
    @RequestMapping(value = "saveCouponDetails.do", method = RequestMethod.POST)
    public XltcResult saveCouponDetails(@RequestBody CouponDetailsModel model){
    	service.saveCouponDetails(model);
    	return XltcResult.ok();
    }
    
    @RequestMapping(value = "selectCouponDetails.do", method = RequestMethod.POST)
    public XltcResult selectCouponDetails(String couponId, CommonPage page){
    	return XltcResult.ok(service.selectCouponDetails(couponId, page));
    }

    @RequestMapping(value = "deleteDetails.do", method = RequestMethod.POST)
    public XltcResult deleteDetails(String couponId, String type, String... codes){
    	service.deleteDetails(couponId, type, codes);
    	return XltcResult.ok();
    }
    
    @RequestMapping(value = "selectAllCoupon.do", method = RequestMethod.GET)
    public XltcResult selectAllCoupon(){
    	return XltcResult.ok(CouponType.findAll());
    }
    
    @RequestMapping(value = "selectAllCouponByMap.do", method = RequestMethod.GET)
    public XltcResult findAllByMap(){
    	return XltcResult.ok(CouponType.findAllByMap());
    }
    
    @RequestMapping(value = "deleteCoupon.do", method = RequestMethod.GET)
    public XltcResult deleteCoupon(String... ids){
    	service.deleteCoupon(ids);
    	return XltcResult.ok();
    }
    
}
