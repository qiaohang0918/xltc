package com.qigan.qiganshop.service.impl;

import com.qigan.qiganshop.constant.RedisConstant;
import com.qigan.qiganshop.constant.TimeFormat;
import com.qigan.qiganshop.mapper.GoodsMapper;
import com.qigan.qiganshop.mapper.TbActivityMainMapper;
import com.qigan.qiganshop.mapper.TbActivityUnionGoodsMapper;
import com.qigan.qiganshop.mapper.TbActivityUnionMapper;
import com.qigan.qiganshop.myutils.SqlConstructUtils;
import com.qigan.qiganshop.pojo.*;
import com.qigan.qiganshop.service.XltcActivityManageService;
import com.qigan.qiganshop.util.access.JedisUtil;
import com.qigan.qiganshop.util.notnull.StringNotNull;
import com.qigan.qiganshop.util.result.XltcResult;
import io.swagger.annotations.Example;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Primary;
import org.springframework.stereotype.Service;
import org.springframework.test.context.jdbc.Sql;
import org.springframework.transaction.annotation.Transactional;

import java.util.*;
import java.util.stream.Collectors;

/**
 * @Aurher: QiaoHang
 * @Description:
 * @Data: 2019/10/17 14:20
 * @Modified By:
 */
@Service
@Transactional(rollbackFor = Exception.class)
public class XltcActivityManageServiceImpl implements XltcActivityManageService {

    @Autowired
    TbActivityMainMapper activityMainMapper;
    @Autowired
    TbActivityUnionMapper activityUnionMapper;
    @Autowired
    TbActivityUnionGoodsMapper activityUnionGoodsMapper;
    @Autowired
    GoodsMapper goodsMapper;
    @Value("${local_pic_url}")
    private String localPicHead;
    @Autowired
    JedisUtil jedisUtil;

    /**
     * 添加主活动
     * @param activity
     * @return
     */
    @Override
    public XltcResult addMainActivity(TbActivityMain activity) {
        //校验重复活动id
        TbActivityMain activityMain = activityMainMapper.selectByPrimaryKey(activity.getActivityId());
        if(activityMain!=null)
            return XltcResult.error("已存在活动唯一Key,换一个Key重新添加!");
        //插入新活动
        activity.setMainPicture(activity.getTopPicture());
        activity.setCreateTime(TimeFormat.nomalFormat.format(new Date()));
        activity.setActivityStatus("1");
        int i = activityMainMapper.insertSelective(activity);
        return XltcResult.ok();
    }

    /**
     * 修改活动分类
     * @param activity
     * @return
     */
    @Override
    public XltcResult updateMainActivity(TbActivityMain activity) {
        int i = activityMainMapper.updateByPrimaryKeySelective(activity);
        return XltcResult.ok();
    }

    /**
     * 查询活动分类
     * @param activity
     * @return
     */
    @Override
    public XltcResult findMainActivity(TbActivityMain activity) {
        TbActivityMainExample example = new TbActivityMainExample();
        TbActivityMainExample.Criteria criteria = example.createCriteria();
        if(StringNotNull.check(activity.getActivityId())){
            criteria.andActivityIdEqualTo(activity.getActivityId());
        }
        if(StringNotNull.check(activity.getActivityStatus())){
            criteria.andActivityStatusEqualTo(activity.getActivityStatus());
        }
        if(StringNotNull.check(activity.getActivityName())){
            criteria.andActivityNameLike("%"+activity.getActivityName()+"%");
        }
        List<TbActivityMain> activityMains = activityMainMapper.selectByExample(example);
        return XltcResult.ok(SqlConstructUtils.dealNullList(activityMains));
    }

    /**
     * 删除主活动(连带其活动子分类以及关联的商品)
     * @param activity
     * @return
     */
    @Override
    public XltcResult deleteMainActivity(TbActivityMain activity) {
        //删除主活动
        int deleteMain = activityMainMapper.deleteByPrimaryKey(activity);
        if(deleteMain>0){
            //查询主活动下的关联活动
            TbActivityUnionExample unionExample = new TbActivityUnionExample();
            TbActivityUnionExample.Criteria criteria = unionExample.createCriteria();
            criteria.andActivityIdEqualTo(activity.getActivityId());
            List<TbActivityUnion> unions = activityUnionMapper.selectByExample(unionExample);
            //删除 该活动相关 union
            int deleteResult = activityUnionMapper.deleteByExample(unionExample);
            //获取 union primarykey id
            List<String> unionIds = getUnionIds(unions);
            if(!SqlConstructUtils.nullList(unionIds)){
                //删除关联商品 tb_activity_union_goods
                TbActivityUnionGoodsExample unionGoodsExample = new TbActivityUnionGoodsExample();
                TbActivityUnionGoodsExample.Criteria unionGoodsCriteria = unionGoodsExample.createCriteria();
                unionGoodsCriteria.andUnionIdIn(unionIds);
                activityUnionGoodsMapper.deleteByExample(unionGoodsExample);
            }
            return XltcResult.ok();
        }else {
            return XltcResult.error("该活动不存在，请刷新页面！");
        }
    }

    /**
     * 添加联合分类
     * @param union
     * @return
     */
    @Override
    public XltcResult addUnionType(TbActivityUnion union) {
        //排除重复的 该分类下的联合排序
        TbActivityUnionExample example = new TbActivityUnionExample();
        TbActivityUnionExample.Criteria criteria = example.createCriteria();
        criteria.andActivityIdEqualTo(union.getActivityId());
        List<TbActivityUnion> tbActivityUnions = activityUnionMapper.selectByExample(example);
        if(SqlConstructUtils.nullList(tbActivityUnions)) {
            return XltcResult.error("该活动不存在！");
        }else {
            List<TbActivityUnion> collect = tbActivityUnions.stream().filter(x -> {
                return union.getUnionSort().equalsIgnoreCase(x.getUnionSort());
            }).collect(Collectors.toList());
            if(!SqlConstructUtils.nullList(collect)){
                return XltcResult.error("该活动下已经存在排序号为[ " + union.getUnionSort() + " ]的联合分类，请重新选择排序号！");
            }
        }
        union.setUnionId(generatorUUID());
        int i = activityUnionMapper.insertSelective(union);
        return XltcResult.ok();
    }


    /**
     * 编辑联合分类
     * @param union
     * @return
     */
    @Override
    public XltcResult updateUnionType(TbActivityUnion union) {
        TbActivityUnion tbActivityUnion = activityUnionMapper.selectByPrimaryKey(union.getUnionId());
        if(tbActivityUnion==null)
            return XltcResult.error("当前编辑的关联分类不存在,请刷新重试！");
        //这里不校验排序字段，后台操作人员手输入，控制排序，学小越靠前...
        if(StringNotNull.check(union.getUnionSort())){
            try {
                Integer.parseInt(union.getUnionSort());
            }catch (Exception e){
                return XltcResult.error("排序号必须是数字格式，排序号越小越靠前，请尽量保证统计分类下排序号不同！");
            }
        }
        int i = activityUnionMapper.updateByPrimaryKeySelective(union);
        return XltcResult.ok();
    }

    /**
     * 删除关联分类
     * @param union
     * @return
     */
    @Override
    public XltcResult deleteUnionType(TbActivityUnion union) {
        int i = activityUnionMapper.deleteByPrimaryKey(union.getUnionId());
        if(i>0){
            //删除该关联分类下的关联商品
            TbActivityUnionGoodsExample example = new TbActivityUnionGoodsExample();
            TbActivityUnionGoodsExample.Criteria criteria = example.createCriteria();
            criteria.andUnionIdEqualTo(union.getUnionId());
            int i1 = activityUnionGoodsMapper.deleteByExample(example);
        }
        return XltcResult.ok();
    }

    /**
     * 关联商品
     * @param list
     * @return
     */
    @Override
    public XltcResult unionGoods(List<TbActivityUnionGoods> list) {
        int i = 0;
        for (TbActivityUnionGoods unionGoods : list) {
            if(StringNotNull.check(unionGoods.getUnionId(),unionGoods.getGoodsCode())) {
                //查询是否已经关联（如果已经关联，则 continue！）
                TbActivityUnionGoodsExample example = new TbActivityUnionGoodsExample();
                TbActivityUnionGoodsExample.Criteria criteria = example.createCriteria();
                criteria.andGoodsCodeEqualTo(unionGoods.getGoodsCode());
                criteria.andUnionIdEqualTo(unionGoods.getUnionId());
                List<TbActivityUnionGoods> tbActivityUnionGoods = activityUnionGoodsMapper.selectByExample(example);
                if(!SqlConstructUtils.nullList(tbActivityUnionGoods)) {
                    continue;
                }
                unionGoods.setUnionGoodsId(this.generatorUUID());
                //查询goodsCode
                String goodsId = goodsMapper.findGoodsIdByCode(unionGoods.getGoodsCode());
                unionGoods.setGoodsId(goodsId);
                int insert = activityUnionGoodsMapper.insert(unionGoods);
                ++i;
            }else {
                return XltcResult.error("部分商品关联失败[ code / unionId ]为空了！");
            }
        }
        if(list.size() == i )
            return XltcResult.ok();
        else
            return XltcResult.error("数据异常，或存在已经关联过的商品,请新页面后重新选择关联!");
    }

    /**
     * 解除关联商品
     * @param list
     * @return
     */
    @Override
    public XltcResult releaseUnionGoods(List<TbActivityUnionGoods> list) {
        int i = 0;
        for (TbActivityUnionGoods unionGoods : list) {
            if(StringNotNull.check(unionGoods.getUnionId(),unionGoods.getGoodsCode())) {
                TbActivityUnionGoodsExample example = new TbActivityUnionGoodsExample();
                TbActivityUnionGoodsExample.Criteria criteria = example.createCriteria();
                criteria.andUnionIdEqualTo(unionGoods.getUnionId());
                criteria.andGoodsCodeEqualTo(unionGoods.getGoodsCode());
                int insert = activityUnionGoodsMapper.deleteByExample(example);
                ++i;
            }else {
                return XltcResult.error("部分商品关联失败[ code / unionId ]为空了！");
            }
        }
        return XltcResult.ok();
    }

    /**
     * 查询关联分类(不查询商品 web用)
     * @param union
     * @return
     */
    @Override
    public XltcResult findUnionTypes(TbActivityUnion union) {
        TbActivityUnionExample example = new TbActivityUnionExample();
        TbActivityUnionExample.Criteria criteria = example.createCriteria();
        if(StringNotNull.check(union.getUnionId())){
            criteria.andUnionIdEqualTo(union.getUnionId());
        }
        if(StringNotNull.check(union.getActivityId())){
            criteria.andActivityIdEqualTo(union.getActivityId());
        }
        if(StringNotNull.check(union.getUnionName())){
            criteria.andUnionNameLike("%"+union.getUnionName()+"%");
        }
        example.setOrderByClause("union_sort asc");
        List<TbActivityUnion> unions = activityUnionMapper.selectByExample(example);
        return XltcResult.ok(SqlConstructUtils.dealNullList(unions));
    }

    /**
     * 查询关联商品(分类id)
     * @param unionId
     * @param wareId
     * @return
     */
    @Override
    public XltcResult findUnionGoods(String unionId,String wareId) {
       List<XltcGoodsModel> goods =  activityUnionGoodsMapper.findUnionGoods(unionId,localPicHead,wareId);
       if(!SqlConstructUtils.nullList(goods)) {
           //限购商品打标
           this.tagLimitedCode(goods);
       }
       return XltcResult.ok(goods==null?new ArrayList<>():goods);
    }

    /**
     * 限购商品打标
     */
    public void tagLimitedCode(List<XltcGoodsModel> goods){
        //获取所有限购商品code
        Set<String> limitedCodes = this.getAllLimitedCodes();
        if(limitedCodes!=null){
            for (XltcGoodsModel good : goods) {
                String goodsCode = good.getGoodsCode();
                if(StringNotNull.check(goodsCode)){
                    if(limitedCodes.contains(goodsCode.trim())){
                        //是限购商品，打标
                        good.setIsLimitedGoods("1");
                    }
                }
            }
        }
    }

    /**
     * 获取所有限购商品code
     * @return
     */
    public Set<String> getAllLimitedCodes(){
        HashSet<String> resultCodes = new HashSet<>();
        Set<String> limitedCode = jedisUtil.getMembersFromSet(RedisConstant.LIMITED_CODES);
        Set<String> limitedCodeCasue = jedisUtil.getMembersFromSet(RedisConstant.LIMITED_CODES_CASUE);
        if(limitedCode!=null && limitedCode.size()>0)
            resultCodes.addAll(limitedCode);
        if(limitedCodeCasue!=null && limitedCodeCasue.size()>0)
            resultCodes.addAll(limitedCodeCasue);
        return resultCodes==null || resultCodes.size()<=0 ? null : resultCodes;
    }


    /**
     * 获取关联ids
     * @param unions
     * @param unions
     * @return
     */
    public List<String> getUnionIds(List<TbActivityUnion> unions){
        if(SqlConstructUtils.nullList(unions))
            return null;
        //获取关联id集合  unionId
        List<String> collect = unions.stream().map(x -> {
            return x.getUnionId();
        }).collect(Collectors.toList());
        return collect == null ? null : collect;
    }



    /**
     * 随机 UUID
     * @return
     */
    public String generatorUUID(){
        return UUID.randomUUID().toString().replace("-","");
    }
}



