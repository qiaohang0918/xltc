package com.qigan.qiganshop.controller.backstage;

import com.qigan.qiganshop.constant.RedisConstant;
import com.qigan.qiganshop.controller.utils.PublicControl;
import com.qigan.qiganshop.myutils.SqlConstructUtils;
import com.qigan.qiganshop.pojo.Coupon;
import com.qigan.qiganshop.service.CouponService;
import com.qigan.qiganshop.util.access.JedisUtil;
import com.qigan.qiganshop.util.notnull.StringNotNull;
import com.qigan.qiganshop.util.result.PageResult;
import com.qigan.qiganshop.util.result.XltcResult;
import com.qigan.qiganshop.util.result.format.JsonResult;
import com.qigan.qiganshop.util.result.format.ResultCode;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RestController;

import java.util.List;
import java.util.Map;
import java.util.Set;

/**
 * ä¼˜æƒ åˆ¸ controller
 *
 * @author wanghao
 * @time 2019-05-05 17:51
 */
@SuppressWarnings("all")

@RestController
@RequestMapping("/Coupon")
@Api(value = "ä¼˜æƒ åˆ¸ controller", tags = {"WEB ä¼˜æƒ åˆ¸æ“ä½œæ¥å£"})
public class CouponController {
    @Autowired
    private CouponService service;
    @Autowired
    private JsonResult jr;
    @Autowired
    private PublicControl pc;
    @Autowired
    private JedisUtil jedisUtil;


    /**
     * æ·»åŠ çº¿ç´¢ç”¨æˆ·ç¦åˆ©ä¼˜æƒ å·
     * @param couponIds
     * @return
     */
    @RequestMapping(value = "/addClueUserCoupons.do",method = RequestMethod.POST)
    public XltcResult addClueUserCoupons(List<Map<String,String>> data){
        if(SqlConstructUtils.nullList(data))
            return XltcResult.error("è¯·ä¼ å…¥è‡³å°‘ä¸€ä¸ªä¼˜æƒ å·idï¼");
        for (Map<String, String> couponDateMap : data) {
            String couponId = couponDateMap.get("couponId");
            String useAbleDay = couponDateMap.get("useAbleDay");
            if(StringNotNull.check(couponId,useAbleDay)){
                jedisUtil.setToHash(RedisConstant.CLUE_USER_COUPONS,couponId,useAbleDay);
            }
        }
        return XltcResult.ok();
    }


    /**
     * è·å–å½“å‰çº¿ç´¢ç”¨æˆ·ç¦åˆ©ä¼˜æƒ å·
     * @return
     */
    @RequestMapping(value = "/findClueUserCoupons.do",method = RequestMethod.GET)
    public XltcResult findClueUserCoupons(){
        Set<String> elements = jedisUtil.getElementsFromHash(RedisConstant.CLUE_USER_COUPONS);
        String couponIds = SqlConstructUtils.constructListToStringsOnIn(null, elements);
        if(couponIds==null)
            return XltcResult.ok();
        List<Coupon> list = service.findCouponByIds(couponIds);
        return XltcResult.ok(list);
    }

    /**
     * ç§»é™¤å½“å‰çº¿ç´¢ç”¨æˆ·ç¦åˆ©ä¼˜æƒ å·
     * @param couponIds
     * @return
     */
    @RequestMapping(value = "/removeClueUserCoupons.do",method = RequestMethod.POST)
    public XltcResult removeClueUserCoupons(List<String> couponIds){
        if(SqlConstructUtils.nullList(couponIds))
            return XltcResult.ok();
        for (String couponId : couponIds) {
            jedisUtil.removeElementFromHash(RedisConstant.CLUE_USER_COUPONS,couponId);
        }
        return XltcResult.ok();
    }


    /**
     * ä¼˜æƒ åˆ¸æŸ¥è¯¢ä¸‰åˆä¸€
     *
     * @param coupon
     * @param page
     * @param size
     * @return
     */
    @RequestMapping("findPage.do")
    @ApiOperation(
            value = "åˆ†é¡µè·å–æ‰€æœ‰çš„ä¼˜æƒ åˆ¸åˆ—è¡¨  ä¼˜æƒ åˆ¸ç±»å‹ 1,æ»¡å‡ 2,å…è¿è´¹,3 é¸¡è›‹åˆ¸",
            notes = "åˆ†é¡µè·å–ä¼˜æƒ åˆ¸åˆ—è¡¨ä¿¡æ¯,coupon ä¸ºä¼˜æƒ åˆ¸å®ä½“,ç”¨äºåŠ¨æ€æ‹¼æ¥æŸ¥è¯¢æ¡ä»¶,page ä¸ºé¡µç ,rows ä¸ºæ¯é¡µè®°å½•æ•° \r\n" +
                    "è‹¥è¦æŸ¥è¯¢æ‰€æœ‰,ä¸ä¼ é€’ å®ä½“ coupon å³å¯,page ä¼ 1,rows ä¼  10(é»˜è®¤) \r\n",
            httpMethod = "POST")
    public JsonResult findPage(@RequestBody Coupon coupon, Integer page, Integer size) {
        PageResult result = service.findPage(coupon, page, size);

        return jr.jsonResultData(ResultCode.SUCCESS.res_code(), ResultCode.SUCCESS.message(), result);

    }

    /**
     * æ–°å¢ä¼˜æƒ åˆ¸
     *
     * @param coupon
     * @return
     */
    @RequestMapping("add.do")
    @ApiOperation(
            value = "æ–°å¢ä¼˜æƒ åˆ¸",
            notes = "couponId å¯ä»¥ä¸ä¼ ,ä½†æ˜¯ type,begin,end,å¿…ä¼  \r\n" +
                    "æ–°å¢æ»¡å‡ä¼˜æƒ åˆ¸,couponName,type,fullMoney,reduceMoney,begin,end å¿…ä¼  \r\n" +
                    "æ–°å¢å…è¿è´¹ä¼˜æƒ åˆ¸,couponName,type,begin,end å¿…ä¼  \r\n" +
                    "æ–°å¢é¸¡è›‹ğŸ¥šğŸ¥šğŸ¥šğŸ¥šğŸ¥šğŸ¥šä¼˜æƒ åˆ¸,couponName,type,begin,end,eggNumber å¿…ä¼  \n",
            httpMethod = "POST")
    public JsonResult add(@RequestBody Coupon coupon) {
        if (StringNotNull.check(coupon.getType())) {

            return pc.addUtils(service.add(coupon));
        }
        return jr.jsonResultData(ResultCode.FAIL.res_code(), "æ·»åŠ å¤±è´¥! type ä¸ºç©º");

    }

    /**
     * ä¿®æ”¹ä¼˜æƒ åˆ¸
     *
     * @param coupon
     * @return
     */
    @RequestMapping("update.do")
    @ApiOperation(
            value = "ä¿®æ”¹ä¼˜æƒ åˆ¸",
            notes = "couponId å¯ä»¥ä¸ä¼ ,ä½†æ˜¯ type,begin,end,å¿…ä¼  \r\n" +
                    "ä¿®æ”¹æ»¡å‡ä¼˜æƒ åˆ¸,couponId,couponName,type,fullMoney,reduceMoney,begin,end å¿…ä¼  \r\n" +
                    "ä¿®æ”¹å…è¿è´¹ä¼˜æƒ åˆ¸,couponId,couponName,type,begin,end å¿…ä¼  \r\n" +
                    "ä¿®æ”¹é¸¡è›‹ğŸ¥šğŸ¥šğŸ¥šğŸ¥šğŸ¥šğŸ¥šä¼˜æƒ åˆ¸,couponId,couponName,type,begin,end,eggNumber å¿…ä¼  \n",
            httpMethod = "POST")
    public JsonResult update(@RequestBody Coupon coupon) {
        if (StringNotNull.check(coupon.getCouponId()) && StringNotNull.check(coupon.getType())) {
            return pc.updateUtils(service.update(coupon));
        }
        return jr.jsonResultData(ResultCode.FAIL.res_code(), "æ›´æ–°å¤±è´¥! typeæˆ– Id ä¸ºç©º");


    }

    /**
     * ä¿®æ”¹ä¼˜æƒ åˆ¸
     *
     * @param coupon
     * @return
     */
    @RequestMapping("updateEnable.do")
    @ApiOperation(
            value = "ä¿®æ”¹ä¼˜æƒ åˆ¸",
            notes = "couponIds å¿…é¡»ä¼  flag å¿…é¡»ä¼  å¯ç”¨ 1; ç¦ç”¨ 0",
            httpMethod = "POST")
    public JsonResult updateEnable(String[] couponIds, String flag) {
        if (StringNotNull.check(flag) && couponIds.length > 0) {
            return pc.updateUtils(service.updateEnable(couponIds, flag));
        }
        return jr.jsonResultData(ResultCode.FAIL.res_code(), "æ›´æ–°å¤±è´¥! couponIds æˆ– flag ä¸ºç©º");




    }

    /**
     * åˆ é™¤ä¼˜æƒ åˆ¸
     *
     * @param ids
     * @return
     */
    @RequestMapping("delete.do")
    @ApiOperation(
            value = "åˆ é™¤ä¼˜æƒ åˆ¸ ",
            notes = "ä¼˜æƒ åˆ¸ Id å¿…ä¼ ",
            httpMethod = "POST")
    public JsonResult delete(String[] ids) {
        if (ids.length > 0) {
            return pc.deleteUtils(ids, service.delete(ids));
        }
        return jr.jsonResultData(ResultCode.FAIL.res_code(), "åˆ é™¤å¤±è´¥!! Id ä¸ºç©º");


    }

    /**
     * æŸ¥è¯¢å•ä¸ªä¼˜æƒ åˆ¸è¯¦æƒ…
     *
     * @param couponId
     * @return
     */
    @RequestMapping("findOne.do")
    @ApiOperation(
            value = "æŸ¥è¯¢å•ä¸ªä¼˜æƒ åˆ¸",
            notes = "ä¼˜æƒ åˆ¸ Id å¿…ä¼ ",
            httpMethod = "POST")
    public JsonResult findOne(String couponId) {
        if (StringNotNull.check(couponId)) {
            return jr.jsonResultData(ResultCode.SUCCESS.res_code(), ResultCode.SUCCESS.message(), service.findOne(couponId));
        }
        return jr.jsonResultData(ResultCode.FAIL.res_code(), "åˆ é™¤å¤±è´¥!! Id ä¸ºç©º", new Coupon());
    }

}
